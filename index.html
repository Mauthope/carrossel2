<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Produção</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
    </style>
</head>
<body>
    <h1>Controle de Produção</h1>

    <label for="opNumber">Número da OP:</label>
    <input type="text" id="opNumber"><br>

    <label for="componentCode">Código do Componente:</label>
    <input type="text" id="componentCode"><br>

    <label for="opQuantity">Quantidade da OP:</label>
    <input type="number" id="opQuantity"><br>

    <label for="opLength">Comprimento da OP (em metros):</label>
    <input type="number" id="opLength"><br>

    <label for="fabricType">Tipo de Tecido:</label>
    <select id="fabricType">
        <option value="plano">Plano</option>
        <option value="tubular">Tubular</option>
        <option value="PET">PET</option>
    </select><br>

    <label for="opWeight">Gramatura da OP (em g/m²):</label>
    <input type="number" id="opWeight"><br>

    <label for="piecesRemoved">Quantidade de Peças Retiradas:</label>
    <input type="number" id="piecesRemoved"><br>

    <button onclick="calculate()">Calcular</button>

    <h2>Resultados</h2>
    <p id="numTurnsResult"></p>
    <p id="remainingTurnsResult"></p>
    <p id="totalCutAmountResult"></p>

    <h2>Registros</h2>
    <table id="recordsTable">
        <thead>
            <tr>
                <th>Data e Hora</th>
                <th>Máquinas Ativas</th>
                <th>Número da OP</th>
                <th>Código do Componente</th>
                <th>Quantidade da OP</th>
                <th>Comprimento da OP</th>
                <th>Tipo de Tecido</th>
                <th>Gramatura da OP</th>
                <th>Quantidade de Peças Retiradas</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <button onclick="downloadCSV()">Baixar CSV</button>

    <script>
        let records = [];

        function getActiveMachinesCount() {
            // Implementação para contar máquinas ativas (substitua com sua lógica)
            return Math.floor(Math.random() * 10) + 1; // Exemplo aleatório
        }

        function calculate() {
            const opNumber = document.getElementById('opNumber').value;
            const componentCode = document.getElementById('componentCode').value;
            const opQuantity = parseFloat(document.getElementById('opQuantity').value);
            const opLength = parseFloat(document.getElementById('opLength').value);
            const fabricType = document.getElementById('fabricType').value;
            const opWeight = parseFloat(document.getElementById('opWeight').value);
            const piecesRemoved = parseFloat(document.getElementById('piecesRemoved').value);

            let maxTurns;

            // Determina o número máximo de voltas com base no tipo de tecido e gramatura
            if (fabricType === "plano") {
                maxTurns = calculateMaxTurnsForPlano(opWeight);
            } else if (fabricType === "tubular") {
                maxTurns = calculateMaxTurnsForTubular(opWeight);
            } else if (fabricType === "PET") {
                maxTurns = 25; // Máximo fixo para PET
            }

            document.getElementById('numTurnsResult').textContent = `Número Máximo de Voltas: ${maxTurns}`;

            const cutAmount = opLength * opQuantity; // Cálculo da quantidade cortada
            const numCycles = cutAmount / maxTurns;

            // Cálculo do Restante de Voltas para Fechar a OP
            const fractionalPart = numCycles - Math.floor(numCycles); // Parte decimal
            const additionalCuts = Math.ceil(fractionalPart * cutAmount);
            const remainingTurns = Math.ceil((additionalCuts * maxTurns) / cutAmount);
            document.getElementById('remainingTurnsResult').textContent = `Restante de Voltas para Fechar a OP: ${remainingTurns}`;

            // Cálculo da Quantidade Total Cortada
            const totalCutAmount = ((maxTurns * Math.floor(numCycles) + remainingTurns) * cutAmount);
            document.getElementById('totalCutAmountResult').textContent = `Quantidade Total Cortada: ${totalCutAmount}`;

            const activeMachines = getActiveMachinesCount();
            const record = {
                timestamp: new Date().toLocaleString(),
                activeMachines,
                opNumber,
                componentCode,
                opQuantity,
                opLength,
                fabricType,
                opWeight,
                piecesRemoved
            };

            records.push(record);
            updateRecordsTable();
        }

        function calculateMaxTurnsForPlano(weight) {
            const baseWeight = 65;
            const baseMaxTurns = 80;
            return Math.max(0, Math.floor(baseMaxTurns * (baseWeight / weight))); // Cálculo proporcional
        }

        function calculateMaxTurnsForTubular(weight) {
            const baseWeight = 65;
            const baseMaxTurns = 45;
            return Math.max(0, Math.floor(baseMaxTurns * (baseWeight / weight))); // Cálculo proporcional
        }

        function updateRecordsTable() {
            const tableBody = document.querySelector('#recordsTable tbody');
            tableBody.innerHTML = '';

            records.forEach(record => {
                const row = document.createElement('tr');
                for (let key in record) {
                    const cell = document.createElement('td');
                    cell.textContent = record[key];
                    row.appendChild(cell);
                }
                tableBody.appendChild(row);
            });
        }

        function downloadCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Data e Hora,Máquinas Ativas,Número da OP,Código do Componente,Quantidade da OP,Comprimento da OP,Tipo de Tecido,Gramatura da OP,Quantidade de Peças Retiradas\n";

            records.forEach(record => {
                const row = Object.values(record).join(',');
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "controle_producao.csv");
            document.body.appendChild(link);
            link.click();
        }
    </script>
</body>
</html>
