<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Produção</title>
    <style>
        form {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>Controle de Produção</h1>

    <form id="productionForm">
        <label for="machine">Nome da Máquina:</label>
        <input type="text" id="machine" required><br>

        <label for="opNumber">Número da OP:</label>
        <input type="text" id="opNumber" required><br>

        <label for="componentCode">Código do Componente:</label>
        <input type="text" id="componentCode" required><br>

        <label for="opQuantity">Quantidade da OP:</label>
        <input type="number" id="opQuantity" required><br>

        <label for="opLength">Comprimento da OP (m):</label>
        <input type="number" id="opLength" required><br>

        <label for="fabricType">Tipo de Tecido:</label>
        <select id="fabricType" required>
            <option value="">Selecione</option>
            <option value="Plano">Plano</option>
            <option value="Tubular">Tubular</option>
            <option value="PET">PET</option>
        </select><br>

        <label for="opWeight">Gramatura da OP (g/m²):</label>
        <input type="number" id="opWeight" required><br>

        <label for="piecesRemoved">Quantidade de Peças Retiradas:</label>
        <input type="number" id="piecesRemoved" required><br>

        <button type="button" onclick="addRecord()">Adicionar Registro</button>
        <button type="button" onclick="calculateResults()">Calcular Resultados</button>
    </form>

    <h2>Resultados:</h2>
    <p id="cutsResult">Número de Cortes: </p>
    <p id="turnsResult">Número de Voltas: </p>
    <p id="cutAmountResult">Quantidade Cortada: </p>

    <h2>Registros de Produção</h2>
    <table border="1">
        <thead>
            <tr>
                <th>Data e Hora</th>
                <th>Nome da Máquina</th>
                <th>Número da OP</th>
                <th>Código do Componente</th>
                <th>Quantidade da OP</th>
                <th>Comprimento da OP (m)</th>
                <th>Tipo de Tecido</th>
                <th>Gramatura da OP (g/m²)</th>
                <th>Quantidade de Peças Retiradas</th>
            </tr>
        </thead>
        <tbody id="productionTable">
        </tbody>
    </table>

    <button type="button" onclick="downloadCSV()">Baixar CSV</button>

    <script>
        let records = [];

        function addRecord() {
            const date = new Date().toLocaleString();
            const machine = document.getElementById('machine').value;
            const opNumber = document.getElementById('opNumber').value;
            const componentCode = document.getElementById('componentCode').value;
            const opQuantity = document.getElementById('opQuantity').value;
            const opLength = document.getElementById('opLength').value;
            const fabricType = document.getElementById('fabricType').value;
            const opWeight = document.getElementById('opWeight').value;
            const piecesRemoved = document.getElementById('piecesRemoved').value;

            const record = {
                date,
                machine,
                opNumber,
                componentCode,
                opQuantity,
                opLength,
                fabricType,
                opWeight,
                piecesRemoved
            };

            records.push(record);
            updateTable();
        }

        function updateTable() {
            const productionTable = document.getElementById('productionTable');
            productionTable.innerHTML = '';
            records.forEach(record => {
                const row = document.createElement('tr');
                for (const key in record) {
                    const cell = document.createElement('td');
                    cell.textContent = record[key];
                    row.appendChild(cell);
                }
                productionTable.appendChild(row);
            });
            localStorage.setItem('productionRecords', JSON.stringify(records));
        }

        function downloadCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Data e Hora,Nome da Máquina,Número da OP,Código do Componente,Quantidade da OP,Comprimento da OP,Tipo de Tecido,Gramatura da OP,Quantidade de Peças Retiradas\n";

            records.forEach(record => {
                csvContent += `${record.date},${record.machine},${record.opNumber},${record.componentCode},${record.opQuantity},${record.opLength},${record.fabricType},${record.opWeight},${record.piecesRemoved}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "production_records.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function calculateResults() {
            const fabricType = document.getElementById('fabricType').value;
            const opWeight = parseFloat(document.getElementById('opWeight').value);
            const opLength = parseFloat(document.getElementById('opLength').value);
            const maxCarouselLength = 540;

            // Cálculo do Número de Cortes
            const numCuts = Math.floor(maxCarouselLength / opLength);
            document.getElementById('cutsResult').textContent = `Número de Cortes: ${numCuts}`;

            // Cálculo do Número de Voltas
            let numTurns = 0;
            if (fabricType === 'Plano') {
                numTurns = calculateTurnsPlano(opWeight);
            } else if (fabricType === 'Tubular') {
                numTurns = calculateTurnsTubular(opWeight);
            } else if (fabricType === 'PET') {
                numTurns = 25; // Valor fixo para PET
            }

            document.getElementById('turnsResult').textContent = `Número de Voltas: ${numTurns}`;

            // Cálculo da Quantidade Cortada
            const cutAmount = numCuts * numTurns;
            document.getElementById('cutAmountResult').textContent = `Quantidade Cortada: ${cutAmount}`;
        }

        function calculateTurnsPlano(weight) {
            const baseWeight = 65;
            const baseTurns = 80;
            if (weight === baseWeight) {
                return baseTurns;
            } else {
                const difference = (weight - baseWeight) * 8 / (92 - 80);
                return baseTurns - difference;
            }
        }

        function calculateTurnsTubular(weight) {
            const baseWeight = 65;
            const baseTurns = 45;
            if (weight === baseWeight) {
                return baseTurns;
            } else {
                const difference = (weight - baseWeight) * 8 / (92 - 80);
                return baseTurns - difference;
            }
        }

        function loadRecords() {
            const savedRecords = localStorage.getItem('productionRecords');
            if (savedRecords) {
                records = JSON.parse(savedRecords);
                updateTable();
            }
        }

        window.onload = loadRecords;
    </script>
</body>
</html>
