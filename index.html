<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Produção</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #000;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>Controle de Produção</h1>

    <form id="productionForm">
        <label for="fabricType">Tipo de Tecido:</label>
        <select id="fabricType" required>
            <option value="plano">Plano</option>
            <option value="tubular">Tubular</option>
            <option value="PET">PET</option>
        </select>

        <label for="gramatura">Gramatura:</label>
        <input type="number" id="gramatura" required>

        <label for="opNumber">Número da OP:</label>
        <input type="text" id="opNumber" required>

        <label for="componentCode">Código do Componente:</label>
        <input type="text" id="componentCode" required>

        <label for="opQuantity">Quantidade da OP:</label>
        <input type="number" id="opQuantity" required>

        <label for="opLength">Comprimento da OP:</label>
        <input type="number" id="opLength" required>

        <label for="opWeight">Gramatura da OP:</label>
        <input type="number" id="opWeight" required>

        <label for="piecesRemoved">Quantidade de Peças Retiradas:</label>
        <input type="number" id="piecesRemoved" required>

        <button type="button" onclick="calculate()">Calcular</button>
    </form>

    <div>
        <h2>Resultados</h2>
        <p id="numTurnsResult"></p>
        <p id="remainingTurnsResult"></p>
        <p id="totalCutAmountResult"></p>
    </div>

    <h2>Registros</h2>
    <table id="recordsTable">
        <thead>
            <tr>
                <th>Data e Hora</th>
                <th>Máquinas Ativas</th>
                <th>Número da OP</th>
                <th>Código do Componente</th>
                <th>Quantidade da OP</th>
                <th>Comprimento da OP</th>
                <th>Tipo de Tecido</th>
                <th>Gramatura da OP</th>
                <th>Quantidade de Peças Retiradas</th>
            </tr>
        </thead>
        <tbody>
            <!-- Registros serão inseridos aqui -->
        </tbody>
    </table>

    <button onclick="downloadCSV()">Baixar CSV</button>

    <script>
        let records = [];

        function calculate() {
            const fabricType = document.getElementById('fabricType').value;
            const gramatura = parseFloat(document.getElementById('gramatura').value);
            const opNumber = document.getElementById('opNumber').value;
            const componentCode = document.getElementById('componentCode').value;
            const opQuantity = parseInt(document.getElementById('opQuantity').value);
            const opLength = parseFloat(document.getElementById('opLength').value);
            const opWeight = parseFloat(document.getElementById('opWeight').value);
            const piecesRemoved = parseInt(document.getElementById('piecesRemoved').value);

            let maxTurns;

            // Definindo o número máximo de voltas com base no tipo de tecido e gramatura
            if (fabricType === 'plano') {
                maxTurns = 80 * (65 / gramatura);
            } else if (fabricType === 'tubular') {
                maxTurns = 45 * (65 / gramatura);
            } else if (fabricType === 'PET') {
                maxTurns = 25;
            }

            const numTurns = Math.min(maxTurns, Math.floor(7000 / opWeight)); // Supondo um cálculo baseado em peso

            document.getElementById('numTurnsResult').textContent = `Número de Voltas: ${numTurns}`;

            // Cálculo do número de ciclos
            const cutAmount = opQuantity * opLength; // Cálculo da quantidade cortada
            const numCycles = cutAmount / numTurns;
            document.getElementById('remainingTurnsResult').textContent = `Número de Ciclos: ${numCycles}`;

            // Cálculo do Restante de Voltas para Fechar a OP
            const fractionalPart = numCycles - Math.floor(numCycles); // Parte decimal
            const additionalCuts = Math.ceil(fractionalPart * cutAmount);
            const remainingTurns = Math.ceil((additionalCuts * numTurns) / cutAmount);
            document.getElementById('remainingTurnsResult').textContent = `Restante de Voltas para Fechar a OP: ${remainingTurns}`;

            // Cálculo da Quantidade Total Cortada
            const totalCutAmount = ((numTurns * Math.floor(numCycles) + remainingTurns) * cutAmount);
            document.getElementById('totalCutAmountResult').textContent = `Quantidade Total Cortada: ${totalCutAmount}`;

            const activeMachines = getActiveMachinesCount();
            const record = {
                timestamp: new Date().toLocaleString(),
                activeMachines,
                opNumber,
                componentCode,
                opQuantity,
                opLength,
                fabricType,
                opWeight,
                piecesRemoved
            };

            records.push(record);
            updateRecordsTable();
        }

        function getActiveMachinesCount() {
            // Função fictícia para retornar o número de máquinas ativas
            return Math.floor(Math.random() * 10) + 1; // Exemplo: retorna um número aleatório de 1 a 10
        }

        function updateRecordsTable() {
            const tableBody = document.querySelector('#recordsTable tbody');
            tableBody.innerHTML = '';

            records.forEach(record => {
                const row = document.createElement('tr');
                for (let key in record) {
                    const cell = document.createElement('td');
                    cell.textContent = record[key];
                    row.appendChild(cell);
                }
                tableBody.appendChild(row);
            });
        }

        function downloadCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Data e Hora,Máquinas Ativas,Número da OP,Código do Componente,Quantidade da OP,Comprimento da OP,Tipo de Tecido,Gramatura da OP,Quantidade de Peças Retiradas\n";

            records.forEach(record => {
                const row = Object.values(record).join(',');
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "controle_producao.csv");
            document.body.appendChild(link);
            link.click();
        }
    </script>
</body>
</html>
